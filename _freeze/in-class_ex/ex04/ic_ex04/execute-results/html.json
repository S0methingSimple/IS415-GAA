{
  "hash": "7cae16b5aa48860e97d71cbc329106db",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"In-class Exercise 4\"\nauthor: \"Jeffery Lau\"\ndate: 09-09-2024\ndate-modified: \"last-modified\"\ndescription: |\n  In this exercise we learn how to work with sparr to perform spatial temporal analysis on our data\ncategories:\n  - In-class\nformat:\n  html:\n    toc: true\nexecute: \n  eval: true\n  echo: true\n  warning: false\n  freeze: true\n---\n\n\n# 1. Introduction\n\n# 2. Setup\n\n## 2.1 Loading Packages\n\nWe will be loading the following packages, on top of the standard package with the additional `sparr` to work with spatio-temporal densities\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, raster, spatstat, sparr, tmap, tidyverse)\n```\n:::\n\n\n## 2.2 Import data\n\nNext we import our data required, the boundary and forest fire data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load data\nkbb_sf <- st_read(dsn = \"data/rawdata\", layer = \"Kepulauan_Bangka_Belitung\") %>%\n  st_union() %>%\n  st_zm(drop = TRUE, what = \"ZM\") %>% \n  st_transform(crs = 32748)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Kepulauan_Bangka_Belitung' from data source \n  `/Users/jeffery/Projects/Y4S1/IS415/S0methingSimple/IS415-GAA/in-class_ex/ex04/data/rawdata' \n  using driver `ESRI Shapefile'\nSimple feature collection with 298 features and 27 fields\nGeometry type: POLYGON\nDimension:     XYZ\nBounding box:  xmin: 105.1085 ymin: -3.116593 xmax: 106.8488 ymax: -1.501603\nz_range:       zmin: 0 zmax: 0\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\nff_sf <- read_csv(\"data/rawdata/forestfires.csv\") %>%\n  st_as_sf(coords = c(\"longitude\", \"latitude\"), crs = 4326) %>% # Sequence always long then lat (x -> y)\n  st_transform(crs = 32748)\n```\n:::\n\n\nWe also create an owin for the boundary map\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkbb_owin <- as.owin(kbb_sf)\nclass(kbb_owin)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"owin\"\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(kbb_owin)\n```\n\n::: {.cell-output-display}\n![](ic_ex04_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n## 2.3 Data Wrangling\n\nStart by creating the year of day, month num and abbr for our forest fire\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read_csv can detect the datetype\nff_sf <- ff_sf %>%\n  mutate(DayofYear = yday(acq_date)) %>%\n  mutate(Month_num = month(acq_date)) %>%\n  mutate(Month_fac = month(acq_date, label = T, abbr = F))\n\nff_sf\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 741 features and 16 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 521564.1 ymin: 9658137 xmax: 695791 ymax: 9828767\nProjected CRS: WGS 84 / UTM zone 48S\n# A tibble: 741 × 17\n   brightness  scan track acq_date   acq_time satellite instrument confidence\n *      <dbl> <dbl> <dbl> <date>        <dbl> <chr>     <chr>           <dbl>\n 1       312.   1.3   1.1 2023-01-10      629 Aqua      MODIS              67\n 2       314.   1.2   1.1 2023-01-10      629 Aqua      MODIS              70\n 3       315.   1.2   1.1 2023-01-10      629 Aqua      MODIS              71\n 4       309.   1.2   1.1 2023-01-10      629 Aqua      MODIS              54\n 5       308.   1.2   1.1 2023-01-10      629 Aqua      MODIS              33\n 6       322.   1.3   1.1 2023-01-10      629 Aqua      MODIS              72\n 7       318.   1.2   1.1 2023-01-10      629 Aqua      MODIS              71\n 8       318.   1.2   1.1 2023-01-10      629 Aqua      MODIS              75\n 9       327.   2     1.4 2023-01-12      616 Aqua      MODIS              73\n10       321.   2     1.4 2023-01-12      616 Aqua      MODIS              75\n# ℹ 731 more rows\n# ℹ 9 more variables: version <dbl>, bright_t31 <dbl>, frp <dbl>,\n#   daynight <chr>, type <dbl>, geometry <POINT [m]>, DayofYear <dbl>,\n#   Month_num <dbl>, Month_fac <ord>\n```\n\n\n:::\n:::\n\n\n## 2.4 Data Exploration\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(kbb_sf) + tm_polygons() + \n  tm_shape(ff_sf) + tm_bubbles(size = 0.1, col = \"brightness\") # (markets, symbol -> own emblem), bubbles, squares\n```\n\n::: {.cell-output-display}\n![](ic_ex04_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(kbb_sf) + tm_polygons() +\n  tm_shape(ff_sf) + tm_squares(size = 0.1) +\n  tm_facets(by=\"Month_fac\",\n            free.coords = F,\n            drop.units = T)\n```\n\n::: {.cell-output-display}\n![](ic_ex04_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n# 3. ST KDE\n\n## 3.1 Data Preparation\n\nGet fire month with geometry\n\n\n::: {.cell}\n\n```{.r .cell-code}\nff_month <- ff_sf %>%\n  select(Month_num)\n```\n:::\n\n\nConvert to ppp\n\n\n::: {.cell}\n\n```{.r .cell-code}\nff_month_ppp <- as.ppp(ff_month)\nplot(ff_month_ppp)\n```\n\n::: {.cell-output-display}\n![](ic_ex04_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nNo duplicates detected\n\n\n::: {.cell}\n\n```{.r .cell-code}\nany(duplicated(ff_month_ppp))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] FALSE\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nff_ppp_owin <- ff_month_ppp[kbb_owin]\nplot(ff_ppp_owin)\n```\n\n::: {.cell-output-display}\n![](ic_ex04_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## 3.2 Compute ST KDE\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_kde <- spattemp.density(ff_ppp_owin)\nsummary(st_kde)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSpatiotemporal Kernel Density Estimate\n\nBandwidths\n  h = 15102.47 (spatial)\n  lambda = 0.0304 (temporal)\n\nNo. of observations\n  741 \n\nSpatial bound\n  Type: polygonal\n  2D enclosure: [512066.8, 705559.4] x [9655398, 9834006]\n\nTemporal bound\n  [1, 12]\n\nEvaluation\n  128 x 128 x 12 trivariate lattice\n  Density range: [1.233458e-27, 8.202976e-10]\n```\n\n\n:::\n:::\n\n\nVisualize the kde\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntims <- c(7,8,9,10,11,12)\npar(mfcol = c(2,3))\nfor(i in tims) {\n  plot(st_kde, i,\n       override.par = F,\n       fix.range = T,\n       main=paste(\"KDE at month\",i))\n  }\n```\n\n::: {.cell-output-display}\n![](ic_ex04_files/figure-html/unnamed-chunk-12-1.png){width=1152}\n:::\n:::\n\n\n## 3.3 Altenative method\n\n\n::: {.cell}\n\n```{.r .cell-code}\nff_doy <- ff_sf %>%\n  select(DayofYear) %>% \n  as.ppp()\n\nff_doy_owin <- ff_doy[kbb_owin]\nplot(ff_doy_owin)\n```\n\n::: {.cell-output-display}\n![](ic_ex04_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Take yday owin\nst_doy_kde <- spattemp.density(ff_doy_owin)\nsummary(st_doy_kde)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSpatiotemporal Kernel Density Estimate\n\nBandwidths\n  h = 15102.47 (spatial)\n  lambda = 6.3198 (temporal)\n\nNo. of observations\n  741 \n\nSpatial bound\n  Type: polygonal\n  2D enclosure: [512066.8, 705559.4] x [9655398, 9834006]\n\nTemporal bound\n  [10, 352]\n\nEvaluation\n  128 x 128 x 343 trivariate lattice\n  Density range: [3.959516e-27, 2.751287e-12]\n```\n\n\n:::\n:::\n\n\nCheckout animation (https://tilmandavies.github.io/sparr/articles/fmd_animation/fmd_animation.html) to see the diffusion\n",
    "supporting": [
      "ic_ex04_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}